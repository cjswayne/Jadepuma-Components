{% comment %} 
 
  Custom app block added by JadePuma
  Instructions - https://jadepuma.com/blogs/shopify-tutorials/promote-a-product-in-an-article-in-the-flex-theme
  Last editted - 2/12/24 
{% endcomment %}

{% assign feature_product_array = article.metafields.jadepuma.featured_products.value %}
{% assign num_products = 0 %}

{% for product in feature_product_array %}

  {% assign num_products = num_products | plus: 1 %}

{% endfor %}

{% if num_products > 0 %}

  {% style %}
    #jp-section-{{ block.id }} {
      padding-top: {{ block.settings.padding_top }}px;
      padding-bottom: {{ block.settings.padding_bottom }}px;
      {% if block.settings.width == 'wide' -%}
        width: 100%;
      {%- endif %}
    }
    .section-heading-{{ section.id }} {
      background-color: {{ block.settings.heading_background_color }};
      color: {{ block.settings.heading_color }};
      text-align: center;
      padding: 1em;
      margin-bottom: 20px;
      text-transform: uppercase;
    }
    .center {
      text-align: center;
    }

  {% endstyle %}

  <link rel="stylesheet" href="https://glacial-thicket-86354-6b7ec0b9d5b3.herokuapp.com/styles.css" />


  {% comment %} HTML markup {% endcomment %}
  <section
    class="section
                  {{ block.settings.css_class }}
                  is-width-{{ block.settings.width }}
                  "
    {% if block.settings.animation !="none" %}
    data-scroll-class="{{ block.settings.animation }}"
    {% endif %}>

    {% if num_products == 1 %}
      {% for product in feature_product_array %}
        <h2 class="section-heading-{{ block.id }}">{{ block.settings.heading }}</h2>
        <div class="product-{{ product.id }}">
          {% comment %} #################### RELATED PRODUCT #################### {% endcomment %}

          {% assign product = product %}
          {% assign sold_out_options = settings.sold_out_options %}
          {% assign selected_variant = product.first_available_variant %}
          {% assign width = width %}
          {% assign css_class = css_class %}
          {% assign display_thumbnails = block.settings.display_thumbnails %}
          {% assign enable_product_lightbox = block.settings.enable_product_lightbox %}
          {% assign enable_shopify_product_badges = block.settings.enable_shopify_product_badges %}
          {% assign enable_thumbnail_slider = block.settings.enable_thumbnail_slider %}
          {% assign enable_zoom = block.settings.enable_zoom %}
          {% assign gallery_arrows = block.settings.gallery_arrows %}
          {% assign product_height = block.settings.product_height %}
          {% assign product_images_position = block.settings.product_images_position %}
          {% assign set_product_height = block.settings.set_product_height %}
          {% assign slideshow_transition = block.settings.slideshow_transition %}
          {% assign stickers_enabled = settings.stickers_enabled %}
          {% assign tag_style = settings.tag_style %}
          {% assign thumbnail_position = block.settings.thumbnail_position %}
          {% assign video_looping = block.settings.video_looping %}
          {% assign section_onboarding = section_onboarding %}
          

          <div class="product_section
            js-product_section
            container
            is-justify-space-between
            has-padding-bottom
            {% if product_images_position == 'right' %}
              is-flex-row-reverse
            {% endif %}">

            <div class="product__images
              one-half
              column
              medium-down--one-whole">
              {% if section_onboarding %}
                <div class="featured-product__images">
                  {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg placeholder-svg--product' }}
                </div>
              {% else %}
                {% render 'product__images'
                  ,
 product: product
                  ,
 display_thumbnails: display_thumbnails
                  ,
 thumbnail_position: thumbnail_position
                  ,
 enable_thumbnail_slider: enable_thumbnail_slider
                  ,
 product_height: product_height
                  ,
 set_product_height: set_product_height
                  ,
 video_looping: video_looping
 gallery_arrows: gallery_arrows
                  ,
 slideshow_transition: slideshow_transition
                  ,
 enable_product_lightbox: enable_product_lightbox
                  ,
 enable_zoom: enable_zoom
                %}
              {% endif %}
            </div>

            <div class="product__information
              has-product-sticker
              one-half
              column
              medium-down--one-whole">

              {% comment %} Sale sticker {% endcomment %}
              {% if stickers_enabled %}
                {% assign collection_handles = product.collections | map: 'handle' %}
                {% render 'product-thumbnail__sticker'
                  ,
 context: 'product'
                  ,
 collection_handles: collection_handles
                  ,
                %}
              {% endif %}


              <div class="product-block
                product-block--{{ block.type | downcase | replace: '_', '-' }}
                {% if forloop.first == true %}
                  product-block--first
                {% endif %}" {{ block.shopify_attributes }}>


                {% comment %} Name {% endcomment %}
                <h1 class="product_name title">
                  {% if section_id == 'quickshop' %}
                    <a href="{{ product.url }}">{{ product.title }}</a>
                  {% elsif section_onboarding %}
                    {{ 'homepage.onboarding.product_title' | t }}
                  {% else %}
                    {{ product.title }}
                  {% endif %}
                </h1>

              </div>

              <div class="product-block
                product-block--{{ block.type | downcase | replace: '_', '-' }}
                {% if forloop.first == true %}
                  product-block--first
                {% endif %}" {{ block.shopify_attributes }}>

                {% comment %} Price {% endcomment %}

                <div
                  class="modal_price subtitle"
                  style="{% if section.settings.hide-price == true %} display:none;{% endif %}"
                  data-display-savings="{{ block.settings.display_savings }}">
                  {% if section_onboarding %}
                    <span class="money">$49.00</span>
                  {% else %}
                    {% comment %}Inject @pixelunion/shopify-price-ui/price-ui begin{% endcomment %}
                    <div class="price-ui price-ui--loading" data-price-ui>
                      <noscript>
                        <style>
                          .price-ui--loading {
                            display: block !important;
                            opacity: 1 !important;
                          }
                        </style>
                      </noscript>
                      {% assign compare_at_price = false %}

                      {% if product.compare_at_price and product.compare_at_price != product.price %}
                        {% if product.compare_at_price_varies %}
                          {%- capture price_min -%}
              {%-
              render 'price-ui-templates',
              template: 'price-min',
              value: product.compare_at_price_min,
              -%}
              {%- endcapture -%}

                          {%- capture price_max -%}
              {%-
              render 'price-ui-templates',
              template: 'price-max',
              value: product.compare_at_price_max,
              -%}
              {%- endcapture -%}

                          {%- assign compare_at_price = 'product.price.range_html' | t: price_min: price_min, price_max: price_max
                          -%}
                        {% else %}
                          {%- capture compare_at_price -%}
              {%-
              render 'price-ui-templates',
              template: 'price',
              value: product.compare_at_price,
              -%}
              {%- endcapture -%}
                        {% endif %}
                      {% endif %}

                      {% if product.price_varies %}
                        {%- capture price_min -%}
              {%-
              render 'price-ui-templates',
              template: 'price-min',
              value: product.price_min,
              -%}
              {%- endcapture -%}

                        {%- capture price_max -%}
              {%-
              render 'price-ui-templates',
              template: 'price-max',
              value: product.price_max,
              -%}
              {%- endcapture -%}

                        {%- assign price = 'product.price.range_html' | t: price_min: price_min, price_max: price_max -%}

                      {% else %}
                        {%- capture price -%}
              {%-
              render 'price-ui-templates',
              template: 'price',
              value: product.price,
              -%}
              {%- endcapture -%}
                      {% endif %}

                      {%- render 'price-ui-templates'
                        ,
 template: 'price-ui'
                        ,
 compare_at_price: compare_at_price
                        ,
 price: price
                        ,
 unit_pricing: false
                        ,
                      -%}
                    </div>
                    {% comment %}Inject @pixelunion/shopify-price-ui/price-ui end{% endcomment %}

                  {% endif %}
                </div>

              </div>


              {% comment %} Purchase form {% endcomment %}
              {% if section_onboarding %}
                <div class="product-form-container has-padding-top">
                  <div class="purchase-details">
                    <div class="purchase-details__buttons purchase-details__spb--false">
                      <button
                        name="add"
                        class="action_button button button--add-to-cart add_to_cart"
                        data-label={{ add_to_cart_label | json }}>
                        <span class="text">{{ 'products.product.add_to_cart' | t }}</span>
                      </button>
                    </div>
                  </div>
                </div>
              {% else %}
                <div class="product-form-container has-padding-top">

                  {% comment %} Notify form {% endcomment %}
                  {% render 'product__notify-me-form'
                    , product: product %}

                  {% comment %} Product form {% endcomment %}
                  {% unless collection_handles contains 'coming-soon' %}
                    {% render 'product__form'
                      ,
 context: 'product'
                      ,
 product: product
                      ,
 sold_out_options: sold_out_options
                      ,
 selected_variant: selected_variant
                      ,
 show_payment_button: section.settings.show_payment_button
                      ,
 collection_handles: collection_handles
                    %}
                  {% endunless %}
                </div>
              {% endif %}


              {% if section.settings.show_description %}

                <div class="product-block
                  product-block--{{ block.type | downcase | replace: '_', '-' }}
                  {% if forloop.first == true %}
                    product-block--first
                  {% endif %}" {{ block.shopify_attributes }}>

                  {% comment %} Description {% endcomment %}
                  {% if section.settings.custom_description != blank %}
                    <div class="description content has-padding-top">
                      {{ section.settings.custom_description }}
                    </div>
                  {% elsif section_onboarding %}
                    <div class="description content has-padding-top">
                      <p>
                        {{ 'homepage.onboarding.product_description' | t }}
                      </p>
                    </div>
                  {% else %}
                    {% if product.description != blank %}
                      <div class="description content has-padding-top">
                        {{ product.description | split: '<!-- split -->' | first }}
                      </div>
                    {% endif %}
                  {% endif %}


                </div>
              {% endif %}
            </div>
          </div>

        {% comment %} #################### END RELATED PRODUCT #################### {% endcomment %}

        </div>
        <div class="center">
          <button class="button action_button action_button--primary">
            <a href="/products/{{ product-handle }}">Learn More</a>
          </button>
        </div>

      {% endfor %}

    {% else %}
        {% comment %} #################### MULTIPLE PRODUCTS #################### {% endcomment %}

      {% assign block_width = 100 | divided_by: block.settings.products_per_row %}

      {% style %}

        .featured_product_grid_layout {
          display: flex;
          flex-direction: row;
          justify-content: center;
          margin-bottom: 50px;
        }


        .featured_product_grid_item {
          position: relative;
          text-align: center;
          margin-bottom: 20px;
          flex-basis: {{ block_width }}%;
          padding: 20px 20px 70px;
        }

        @media only screen and (max-width: 1050px) {
          .featured_product_grid_item {
            text-align: center;
            {% unless block.settings.products_per_row == 2 %}
              flex-basis: 30%;
            {% endunless %}
            margin-top: 20px;
          }
        }

        @media only screen and (max-width: 800px) {
          .featured_product_grid_item {
            text-align: center;
            flex-basis: 45%;
            margin-top: 20px;
          }
        }

        @media only screen and (max-width: 550px) {
          .featured_product_grid_item {
            text-align: center;
            flex-basis: 100%;
            margin-top: 10px;
          }
        }

        .featured_product_grid_image {
          width: auto;
          {% if block.settings.set_grid_images_height %}
            height: {{ block.settings.multiple_products_height }}px;
          {% else %}
            width: 100%;
            height: auto;
          {% endif %}
        }

        .featured_product_grid_button {
          position: absolute;
          bottom: 0;
          left: 50%;
          transform: translateX(-50%);
          margin-top: 20px;
          margin-bottom: 20px;
        }

      {% endstyle %}

      <h2 class="section-heading-{{ block.id }}">{{ block.settings.multiple_products_heading }}</h2>

      <div class="featured_product_grid_layout container">
        {% for product in feature_product_array %}
          <div class="featured_product_grid_item">
            <img class="featured_product_grid_image" src=" {{product.featured_image | img_url: 'large' }}" />
            <div>
              {{ product.title }}
            </div>
            {% unless block.settings.hide-price %}
              <div>
                <span>{{ product.price_min | money_with_currency }} - {{ product.price_max | money_with_currency }}</span>
              </div>
            {% endunless %}
            <div class="featured_product_grid_fixed">
              <a href="{{ product.url }}">
                <button class="button featured_product_grid_button">{{ block.settings.button_text }}</button>
              </a>
            </div>
          </div>
        {% endfor %}
      </div>

    {% endif %}

  </section>

  {% comment %} Shopify-XR {% endcomment %}
  {% if product.media %}
    <script>
        window.ShopifyXR = window.ShopifyXR || function () { (ShopifyXR.q = ShopifyXR.q || []).push(arguments) }
        {% assign models = product.media | where: 'media_type', 'model' | json %}
        ShopifyXR('addModels', {{ models }});
    </script>
  {% endif %}

  {% comment %} JavaScript {% endcomment %}
  <script
    type="application/json"
    data-section-id="{{ block.id }}"
    data-section-data>
    {
      "display_savings": {{ display_savings }},
      "gallery_arrows": {{ block.settings.gallery_arrows | json }},
      "thumbnail_arrows": {{ block.settings.gallery_arrows | json }},
      "enable_zoom": {{ block.settings.enable_zoom | json }},
      "enable_product_lightbox": {{ block.settings.enable_product_lightbox | json }},
      "enable_thumbnail_slider": {{ block.settings.enable_thumbnail_slider | json }},
      "slideshow_speed": {{ block.settings.slideshow_speed | json }},
      "slideshow_transition": {{ block.settings.slideshow_transition | json }},
      "thumbnails_enabled": {{ block.settings.display_thumbnails | json }},
      "thumbnail_position": {{ block.settings.thumbnail_position | json }},
      "product_media_amount": {{ block.settings.product.media.size }},
      "template": "featured-product-section"
    }
  </script>
  <script data-theme-editor-load-script src="https://glacial-thicket-86354-6b7ec0b9d5b3.herokuapp.com/jp-featured-products/script.js"></script>

{% endif %}

{% schema %}
  {
    "name": "JP Article feat products",
    "class": "featured-product-section jsProduct",
    "target": "section",
    "templates": ["article"],
    "settings": [
      {
        "type": "header",
        "content": "Instructions",
        "info": "To promote a product on article, use the article metafields to select the desired product(s)."
      },
      {
        "type": "header",
        "content": "General"
      },
      {
        "type": "text",
        "id": "heading",
        "label": "Single Product Heading",
        "default": "Related Product"
      },
      {
        "type": "text",
        "id": "multiple_products_heading",
        "label": "Multiple Products Heading",
        "default": "Related Products"
      }, {
        "type": "color",
        "id": "heading_color",
        "label": "Text Color"
      }, {
        "type": "color",
        "id": "heading_background_color",
        "label": "Background Color",
        "default": "#FFFFFF"
      }, {
        "type": "checkbox",
        "id": "hide-price",
        "label": "Hide Price",
        "default": false
      }, {
        "type": "text",
        "id": "button_text",
        "label": "Button Text",
        "default": "Shop Now"
      }, {
        "type": "header",
        "content": "Multiple Product Settings"
      }, {
        "type": "range",
        "id": "products_per_row",
        "label": "Products Per Row",
        "min": 2,
        "max": 5,
        "step": 1,
        "default": 3
      }, {
        "type": "checkbox",
        "id": "set_grid_images_height",
        "label": "Set Multiple Products Image Height",
        "default": false
      }, {
        "type": "range",
        "id": "multiple_products_height",
        "label": "Multiple Products Image height",
        "min": 100,
        "max": 800,
        "step": 10,
        "default": 500,
        "unit": "px"
      }, {
        "type": "header",
        "content": "Single Product Settings"
      }, {
        "type": "radio",
        "id": "product_images_position",
        "label": "Media position",
        "options": [
          {
            "value": "left",
            "label": "Left"
          }, {
            "value": "right",
            "label": "Right"
          }
        ],
        "default": "left"
      }, {
        "type": "checkbox",
        "id": "set_product_height",
        "label": "Set Singular Product Image Height",
        "default": false
      }, {
        "type": "range",
        "id": "product_height",
        "label": "Singular Product Image Height",
        "min": 200,
        "max": 800,
        "step": 10,
        "default": 500,
        "unit": "px"
      }, {
        "type": "checkbox",
        "id": "display_thumbnails",
        "label": "Show thumbnails",
        "default": true
      }, {
        "type": "select",
        "id": "thumbnail_position",
        "label": "Thumbnails position",
        "options": [
          {
            "value": "left-thumbnails",
            "label": "Left of main image"
          }, {
            "value": "right-thumbnails",
            "label": "Right of main image"
          }, {
            "value": "bottom-thumbnails",
            "label": "Below main image"
          }
        ],
        "default": "bottom-thumbnails"
      }, {
        "type": "checkbox",
        "id": "enable_thumbnail_slider",
        "label": "Enable thumbnail slider",
        "default": true
      }, {
        "type": "checkbox",
        "id": "video_looping",
        "label": "Enable video looping",
        "default": false
      }, {
        "type": "header",
        "content": "Product gallery"
      }, {
        "type": "checkbox",
        "id": "gallery_arrows",
        "label": "Show arrows",
        "info": "Only applies to desktop",
        "default": true
      }, {
        "type": "checkbox",
        "id": "enable_zoom",
        "label": "Magnify on hover",
        "default": true
      }, {
        "type": "checkbox",
        "id": "enable_product_lightbox",
        "label": "Enable lightbox",
        "default": true
      }, {
        "type": "range",
        "id": "slideshow_speed",
        "label": "Gallery speed",
        "min": 0,
        "max": 6,
        "unit": "sec",
        "default": 0,
        "info": "Set to 0 to disable autoplay."
      }, {
        "type": "select",
        "id": "slideshow_transition",
        "label": "Gallery transition",
        "options": [
          {
            "value": "slide",
            "label": "Slide"
          }, {
            "value": "fade",
            "label": "Fade"
          }
        ],
        "default": "slide"
      }, {
        "type": "text",
        "id": "css_class",
        "label": "Custom CSS Class"
      }
    ]
  }

{% endschema %}